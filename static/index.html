<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Work OS - Hierarchical Task & Resource Management</title>
    <style>
        :root {
            --bg-primary: #f4f4f4;
            --bg-secondary: white;
            --bg-tertiary: #f9f9f9;
            --text-primary: #333;
            --text-secondary: #555;
            --text-muted: #777;
            --border-color: #e0e0e0;
            --border-light: #ddd;
            --accent-color: #667eea;
            --accent-hover: #5a6fd8;
            --success-bg: #d4edda;
            --success-border: #c3e6cb;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-border: #f5c6cb;
            --error-text: #721c24;
            --warning-bg: #fff3cd;
            --warning-border: #ffeaa7;
            --warning-text: #856404;
            --shadow: rgba(0,0,0,0.1);
            --kbd-bg: #f0f0f0;
            --kbd-border: #ccc;
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3d3d3d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #888;
            --border-color: #555;
            --border-light: #666;
            --accent-color: #7c8aed;
            --accent-hover: #6b7ce8;
            --success-bg: #1e3a1e;
            --success-border: #2e5a2e;
            --success-text: #90ee90;
            --error-bg: #3a1e1e;
            --error-border: #5a2e2e;
            --error-text: #ffb3ba;
            --warning-bg: #3a3a1e;
            --warning-border: #5a5a2e;
            --warning-text: #ffeb3b;
            --shadow: rgba(255,255,255,0.1);
            --kbd-bg: #4a4a4a;
            --kbd-border: #666;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            background: var(--bg-secondary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--accent-color) 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 20px;
        }
        
        .nav-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .nav-tab:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .nav-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            background: var(--bg-secondary);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-x: auto;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Grid Layout */
        .content-grid {
            display: grid;
            gap: 20px;
        }
        
        .two-column {
            grid-template-columns: 1fr 1fr;
        }
        
        .three-column {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .sidebar-main {
            grid-template-columns: 300px 1fr;
        }
        
        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px var(--shadow);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 8px var(--shadow);
        }
        
        .card h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Task Tree */
        .task-tree {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .task-node {
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 5px;
            border-left: 3px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .task-node:hover {
            background: var(--bg-tertiary);
            border-left-color: var(--accent-color);
        }
        
        .task-node.selected {
            background: var(--success-bg);
            border-left-color: var(--accent-color);
        }
        
        .task-node.level-0 { margin-left: 0px; }
        .task-node.level-1 { margin-left: 20px; }
        .task-node.level-2 { margin-left: 40px; }
        .task-node.level-3 { margin-left: 60px; }
        .task-node.level-4 { margin-left: 80px; }
        
        .task-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .task-title {
            font-weight: 500;
            flex: 1;
        }
        
        .task-code {
            background: var(--accent-color);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .task-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .progress-bar {
            width: 80px;
            height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            transition: width 0.3s ease;
        }
        
        .status-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .status-new { background: var(--warning-bg); color: var(--warning-text); }
        .status-in_progress { background: var(--accent-color); color: white; }
        .status-blocked { background: var(--error-bg); color: var(--error-text); }
        .status-done { background: var(--success-bg); color: var(--success-text); }
        
        .priority-high { border-left-color: #e74c3c !important; }
        .priority-urgent { border-left-color: #c0392b !important; }
        
        .expand-button {
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.3s ease;
        }
        
        .expand-button:hover {
            background: var(--accent-color);
            color: white;
        }
        
        .task-children {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .task-children.collapsed {
            max-height: 0;
            opacity: 0;
        }
        
        .task-children.expanded {
            max-height: 1000px;
            opacity: 1;
        }
        
        /* Resource List */
        .resource-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .resource-item {
            padding: 10px;
            border: 1px solid var(--border-light);
            border-radius: 5px;
            margin-bottom: 8px;
            background: var(--bg-tertiary);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .resource-item:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-color);
        }
        
        .resource-item.selected {
            background: var(--success-bg);
            border-color: var(--accent-color);
        }
        
        .resource-item.unassigned {
            border-left: 4px solid var(--warning-border);
        }
        
        .resource-item.assigned {
            border-left: 4px solid var(--success-border);
        }
        
        .resource-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .resource-source {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .resource-tasks {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-light);
            border-radius: 5px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        button {
            background: var(--accent-color);
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--border-light);
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Q&A Section */
        .qa-section {
            margin-top: 20px;
        }
        
        .context-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .context-option {
            padding: 8px 12px;
            border: 1px solid var(--border-light);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        
        .context-option:hover {
            border-color: var(--accent-color);
        }
        
        .context-option.active {
            background: var(--accent-color);
            color: white;
        }
        
        .answer-section {
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }
        
        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }
        
        .alert-success {
            background: var(--success-bg);
            border-color: var(--success-border);
            color: var(--success-text);
        }
        
        .alert-error {
            background: var(--error-bg);
            border-color: var(--error-border);
            color: var(--error-text);
        }
        
        .alert-warning {
            background: var(--warning-bg);
            border-color: var(--warning-border);
            color: var(--warning-text);
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-light);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .content-grid.two-column,
            .content-grid.three-column,
            .content-grid.sidebar-main {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                overflow-x: auto;
                padding: 0 10px;
            }
            
            .nav-tab {
                white-space: nowrap;
            }
            
            .main-content {
                padding: 10px;
            }
            
            .context-selector {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .header-actions {
                gap: 10px;
            }
            
            .task-meta {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .expand-button {
                left: -8px;
                width: 14px;
                height: 14px;
                font-size: 8px;
            }
            
            .resource-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
        
        @media (max-width: 480px) {
            .card {
                padding: 15px;
            }
            
            .btn-small {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .resource-item {
                padding: 8px;
            }
            
            .task-node {
                padding: 6px 10px;
                margin: 3px 0;
            }
            
            .form-group label {
                font-size: 14px;
            }
            
            input, textarea, select {
                padding: 8px;
                font-size: 14px;
            }
        }
        
        /* Utilities */
        .hidden { display: none !important; }
        .mt-10 { margin-top: 10px; }
        .mb-10 { margin-bottom: 10px; }
        .text-center { text-align: center; }
        .flex { display: flex; }
        .flex-between { justify-content: space-between; }
        .flex-center { align-items: center; }
        .gap-10 { gap: 10px; }
        
        /* Enhanced loading states */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Enhanced interaction feedback */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🏗️ AI Work OS</h1>
            <div class="header-actions">
                <button class="theme-toggle" onclick="showKeyboardShortcuts()" title="Keyboard Shortcuts (F1)">
                    ❓ Help
                </button>
                <button class="theme-toggle" onclick="toggleTheme()">
                    🌓 Theme
                </button>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('overview')">📊 Tổng quan</div>
            <div class="nav-tab" onclick="switchTab('tasks')">📋 Task Hierarchy</div>
            <div class="nav-tab" onclick="switchTab('resources')">📚 Resource Management</div>
            <div class="nav-tab" onclick="switchTab('qa')">💬 Q&A Context-Aware</div>
            <div class="nav-tab" onclick="switchTab('ingest')">📝 Ingest Documents</div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="content-grid two-column">
                    <div class="card">
                        <h3>📈 System Stats</h3>
                        <div id="stats-content">
                            <div class="loading"></div> Loading system statistics...
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>🎯 Quick Actions</h3>
                        <div style="display: grid; gap: 10px;">
                            <button onclick="switchTab('tasks')">🏗️ Create New Task</button>
                            <button onclick="switchTab('resources')" class="btn-secondary">📚 Manage Resources</button>
                            <button onclick="switchTab('qa')" class="btn-secondary">💬 Ask Question</button>
                            <button onclick="switchTab('ingest')" class="btn-secondary">📝 Add Document</button>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-10">
                    <h3>🌳 Recent Task Activity</h3>
                    <div id="recent-tasks">
                        <div class="loading"></div> Loading recent activity...
                        <div style="margin-top: 15px; font-size: 12px; color: var(--text-muted); text-align: center;">
                            💡 Tip: Use <kbd>Ctrl+N</kbd> to create a new task quickly
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tasks Tab -->
            <div id="tasks" class="tab-content">
                <div class="content-grid sidebar-main">
                    <!-- Task Tree Sidebar -->
                    <div>
                        <div class="card">
                            <h3>🌳 Task Tree</h3>
                            <div style="margin-bottom: 15px;">
                                <button onclick="loadTaskTree()" class="btn-small">🔄 Refresh</button>
                                <button onclick="showCreateTaskModal()" class="btn-small">➕ New Task</button>
                            </div>
                            <div id="task-tree" class="task-tree">
                                <div class="loading"></div> Building task hierarchy...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Task Details -->
                    <div>
                        <div class="card">
                            <h3>📋 Task Details</h3>
                            <div id="task-details">
                                <p style="color: var(--text-muted); text-align: center; padding: 40px;">
                                    Select a task from the tree to view details
                                </p>
                            </div>
                        </div>
                        
                        <div class="card mt-10">
                            <h3>📚 Task Resources</h3>
                            <div id="task-resources">
                                <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                                    Select a task to view its resources
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Resources Tab -->
            <div id="resources" class="tab-content">
                <div class="content-grid two-column">
                    <!-- Resource List -->
                    <div class="card">
                        <h3>📚 All Resources</h3>
                        <div style="margin-bottom: 15px;">
                            <select id="resource-filter" onchange="loadResources()">
                                <option value="">All Resources</option>
                                <option value="unassigned">Unassigned</option>
                                <option value="assigned">Assigned</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                        <div id="resource-list" class="resource-list">
                            <div class="loading"></div> Loading resource library...
                        </div>
                    </div>
                    
                    <!-- Resource Details & Actions -->
                    <div class="card">
                        <h3>⚡ Resource Details & Actions</h3>
                        <div id="resource-actions">
                            <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                                Select a resource to see details and available actions
                            </p>
                        </div>
                        
                        <div class="mt-10">
                            <h4>Bulk Actions</h4>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button onclick="bulkAssignResources()" class="btn-small" disabled>
                                    🔗 Assign to Task
                                </button>
                                <button onclick="bulkArchiveResources()" class="btn-small btn-secondary" disabled>
                                    📦 Archive Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-10">
                    <h3>🔍 Resource Assignment Stats</h3>
                    <div id="resource-stats">
                    <div class="loading"></div> Calculating assignment statistics...
                    </div>
                        
                        <script>
                            // Load resource stats when resources tab is active
                            document.addEventListener('DOMContentLoaded', function() {
                                setTimeout(() => {
                                    if (document.getElementById('resource-stats')) {
                                        loadResourceStats();
                                    }
                                }, 2000);
                            });
                            
                            async function loadResourceStats() {
                                try {
                                    const response = await apiCall('/resources/stats');
                                    const stats = response.data;
                                    
                                    const html = `
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                            <div style="padding: 15px; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                                                <h4 style="margin-bottom: 10px; color: var(--accent-color);">📊 Assignment Rate</h4>
                                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">
                                                    ${Math.round((stats.resource_assignment.resources_by_status.assigned || 0) / Math.max(stats.resource_assignment.total_resources, 1) * 100)}%
                                                </div>
                                                <small>Resources assigned to tasks</small>
                                            </div>
                                            
                                            <div style="padding: 15px; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                                                <h4 style="margin-bottom: 10px; color: var(--accent-color);">🔗 Avg per Task</h4>
                                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">
                                                    ${Math.round((stats.resource_assignment.resources_by_status.assigned || 0) / Math.max(stats.task_hierarchy.total_tasks, 1) * 10) / 10}
                                                </div>
                                                <small>Resources per task</small>
                                            </div>
                                            
                                            <div style="padding: 15px; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                                                <h4 style="margin-bottom: 10px; color: var(--accent-color);">📚 Unassigned</h4>
                                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">
                                                    ${stats.resource_assignment.resources_by_status.unassigned || 0}
                                                </div>
                                                <small>Need assignment</small>
                                            </div>
                                        </div>
                                    `;
                                    
                                    document.getElementById('resource-stats').innerHTML = html;
                                } catch (error) {
                                    document.getElementById('resource-stats').innerHTML = '<p class="alert alert-error">Failed to load assignment statistics</p>';
                                }
                            }
                        </script>
                </div>
            </div>
            
            <!-- Q&A Tab -->
            <div id="qa" class="tab-content">
                <div class="content-grid two-column">
                    <!-- Question Form -->
                    <div class="card">
                        <h3>💬 Ask Question</h3>
                        <form id="qa-form">
                            <div class="form-group">
                                <label>Context Mode</label>
                                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                    <div class="context-option active" data-mode="single" onclick="switchContextMode('single')">Single Task</div>
                                    <div class="context-option" data-mode="multi" onclick="switchContextMode('multi')">Multiple Tasks</div>
                                    <div class="context-option" data-mode="general" onclick="switchContextMode('general')">General Q&A</div>
                                </div>
                            </div>
                            
                            <!-- Single Task Mode -->
                            <div id="single-task-context" class="context-mode-panel">
                                <div class="form-group">
                                    <label>Task Context</label>
                                    <input type="text" id="task-code" placeholder="Enter task code (e.g., TASK-001)">
                                </div>
                            </div>
                            
                            <!-- Multi Task Mode -->
                            <div id="multi-task-context" class="context-mode-panel" style="display: none;">
                                <div class="form-group">
                                    <label>Selected Tasks</label>
                                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                        <button type="button" onclick="showTaskSelector()" class="btn-small">+ Add Tasks</button>
                                        <button type="button" onclick="clearSelectedTasks()" class="btn-small btn-secondary">Clear All</button>
                                    </div>
                                    <div id="selected-tasks-display" style="min-height: 40px; border: 1px solid var(--border-light); border-radius: 5px; padding: 10px; background: var(--bg-tertiary);">
                                        <p style="color: var(--text-muted); text-align: center;">No tasks selected. Click "Add Tasks" to select tasks for context.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Context Scope</label>
                                <div class="context-selector">
                                    <div class="context-option active" data-scope="self">This Task Only</div>
                                    <div class="context-option" data-scope="subtasks">Include Subtasks</div>
                                    <div class="context-option" data-scope="tree">Full Tree</div>
                                    <div class="context-option" data-scope="inherit">With Parents</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Your Question</label>
                                <textarea id="question" placeholder="What would you like to know?" rows="4" required></textarea>
                            </div>
                            
                            <button type="submit">Ask Question</button>
                            <button type="button" onclick="previewContext()" class="btn-secondary">Preview Context</button>
                        </form>
                    </div>
                    
                    <!-- Answer -->
                    <div class="card">
                        <h3>🤖 Answer</h3>
                        <div id="qa-answer">
                            <p style="color: var(--text-muted); text-align: center; padding: 40px;">
                                Ask a question to get started
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-10">
                    <h3>ℹ️ Context Scope Guide</h3>
                    <div id="scope-guide">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div style="padding: 10px; border: 1px solid var(--border-light); border-radius: 5px;">
                                <strong>This Task Only</strong><br>
                                <small>Uses only resources directly assigned to the selected task</small>
                            </div>
                            <div style="padding: 10px; border: 1px solid var(--border-light); border-radius: 5px;">
                                <strong>Include Subtasks</strong><br>
                                <small>Includes resources from the task and all its subtasks</small>
                            </div>
                            <div style="padding: 10px; border: 1px solid var(--border-light); border-radius: 5px;">
                                <strong>Full Tree</strong><br>
                                <small>Uses resources from the entire task hierarchy</small>
                            </div>
                            <div style="padding: 10px; border: 1px solid var(--border-light); border-radius: 5px;">
                                <strong>With Parents</strong><br>
                                <small>Includes resources inherited from parent tasks</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ingest Tab -->
            <div id="ingest" class="tab-content">
                <div class="card">
                    <h3>📝 Add New Document</h3>
                    <form id="ingest-form">
                        <div class="form-group">
                            <label>Document Text</label>
                            <textarea id="document-text" placeholder="Paste your document content here..." rows="8" required></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Source Type</label>
                                <select id="source-type">
                                    <option value="web">Web</option>
                                    <option value="email">Email</option>
                                    <option value="meeting">Meeting Notes</option>
                                    <option value="note">Personal Note</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Source</label>
                                <input type="text" id="source" placeholder="Source description">
                            </div>
                        </div>
                        
                        <button type="submit">Add Document & Extract Tasks</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="modal-overlay" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
        <div id="modal-content" style="background: var(--bg-secondary); padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
            <!-- Modal content will be inserted here -->
        </div>
    </div>

    <script>
        // Global state
        let selectedTask = null;
        let selectedResources = new Set();
        let selectedTasksForContext = new Set();
        let currentScope = 'self';
        let currentContextMode = 'single';
        
        // API configuration
        const API_KEY = 'dummy-key-for-migration';
        const API_BASE = '';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showWelcomeMessage();
            loadStats();
            loadTaskTree();
            loadResources();
            setupEventListeners();
            setupKeyboardShortcuts();
            
            // Add loading state management
            setupGlobalLoadingStates();
        });
        
        function showWelcomeMessage() {
            // Show a brief welcome message for new users
            const hasVisited = localStorage.getItem('hasVisited');
            if (!hasVisited) {
                setTimeout(() => {
                    showAlert('🎉 Welcome to AI Work OS! Press F1 for keyboard shortcuts or click Help in the header.', 'success');
                    localStorage.setItem('hasVisited', 'true');
                }, 1000);
            }
        }
        
        function setupGlobalLoadingStates() {
            // Add global loading state management
            window.addEventListener('beforeunload', function() {
                showAlert('💾 Saving your progress...', 'info');
            });
        }
        
        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        
        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
        }
        
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Update nav
            document.querySelectorAll('.nav-tab').forEach(nav => {
                nav.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load tab-specific data
            switch(tabName) {
            case 'overview':
            loadStats();
            break;
            case 'tasks':
            loadTaskTree();
            break;
            case 'resources':
            loadResources();
            break;
            }
        }
        
        // API helper with enhanced error handling
        async function apiCall(endpoint, options = {}) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
            
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY,
                        ...options.headers
                    },
                    signal: controller.signal,
                    ...options
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.detail) {
                            errorMessage += `: ${errorData.detail}`;
                        }
                    } catch (e) {
                        const text = await response.text();
                        if (text) {
                            errorMessage += `: ${text}`;
                        }
                    }
                    throw new Error(errorMessage);
                }
                
                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                
                if (error.name === 'AbortError') {
                    console.error('API call timeout:', endpoint);
                    showAlert('Request timed out. Please try again.', 'error');
                    throw new Error('Request timeout');
                } else if (error.message.includes('Failed to fetch')) {
                    console.error('Network error:', error);
                    showAlert('Network error. Please check your connection.', 'error');
                    throw new Error('Network error');
                } else {
                    console.error('API call failed:', endpoint, error);
                    if (!error.message.includes('HTTP')) {
                        showAlert(`API Error: ${error.message}`, 'error');
                    }
                    throw error;
                }
            }
        }
        
        // Load stats
        async function loadStats() {
            try {
                const stats = await apiCall('/resources/stats');
                displayStats(stats.data);
                
                // Also load recent tasks for overview tab
                if (document.getElementById('recent-tasks')) {
                    loadRecentTasks();
                }
            } catch (error) {
                document.getElementById('stats-content').innerHTML = '<p class="alert alert-error">Failed to load stats</p>';
            }
        }
        
        async function loadRecentTasks() {
            try {
                const response = await apiCall('/hierarchy/tree');
                const allTasks = flattenTaskTree(response.data);
                
                // Get the 5 most recently updated tasks
                const recentTasks = allTasks
                    .filter(task => task.updated_at || task.created_at)
                    .sort((a, b) => {
                        const dateA = new Date(a.updated_at || a.created_at);
                        const dateB = new Date(b.updated_at || b.created_at);
                        return dateB - dateA;
                    })
                    .slice(0, 5);
                
                displayRecentTasks(recentTasks);
            } catch (error) {
                document.getElementById('recent-tasks').innerHTML = `
                    <p class="alert alert-error">Failed to load recent tasks</p>
                    <div style="margin-top: 15px; font-size: 12px; color: var(--text-muted); text-align: center;">
                        💡 Tip: Use <kbd>Ctrl+N</kbd> to create a new task quickly
                    </div>
                `;
            }
        }
        
        function displayRecentTasks(tasks) {
            if (tasks.length === 0) {
                document.getElementById('recent-tasks').innerHTML = `
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">No recent activity found. Create your first task to get started!</p>
                    <div style="margin-top: 15px; font-size: 12px; color: var(--text-muted); text-align: center;">
                        💡 Tip: Use <kbd>Ctrl+N</kbd> to create a new task quickly
                    </div>
                `;
                return;
            }
            
            const html = tasks.map(task => {
                const date = new Date(task.updated_at || task.created_at);
                const relativeTime = getRelativeTime(date);
                return `
                    <div class="task-node level-0 priority-${task.priority}" 
                         onclick="switchTab('tasks'); setTimeout(() => selectTask('${task.task_code}'), 100)" 
                         style="cursor: pointer; margin: 8px 0;">
                        <div class="task-header">
                            <span class="task-title">${task.title}</span>
                            <span class="task-code">${task.task_code}</span>
                        </div>
                        <div class="task-meta">
                            <span class="status-badge status-${task.status}">${task.status}</span>
                            <span style="font-size: 11px;">${relativeTime}</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${task.progress_percentage}%"></div>
                            </div>
                            <span>${task.progress_percentage}%</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('recent-tasks').innerHTML = `
                ${html}
                <div style="margin-top: 15px; font-size: 12px; color: var(--text-muted); text-align: center;">
                    💡 Tip: Use <kbd>Ctrl+N</kbd> to create a new task quickly
                </div>
            `;
        }
        
        function getRelativeTime(date) {
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours}h ago`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) return `${diffInDays}d ago`;
            
            return date.toLocaleDateString();
        }
        
        function displayStats(stats) {
            const html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <h4>📚 Resources</h4>
                        <p>Total: <strong>${stats.resource_assignment.total_resources}</strong></p>
                        <p>Assigned: <strong>${stats.resource_assignment.resources_by_status.assigned || 0}</strong></p>
                        <p>Unassigned: <strong>${stats.resource_assignment.resources_by_status.unassigned || 0}</strong></p>
                    </div>
                    <div>
                        <h4>📋 Tasks</h4>
                        <p>Total: <strong>${stats.task_hierarchy.total_tasks}</strong></p>
                        <p>Root Tasks: <strong>${stats.task_hierarchy.root_tasks}</strong></p>
                        <p>Max Depth: <strong>${stats.task_hierarchy.max_hierarchy_depth}</strong></p>
                    </div>
                </div>
            `;
            document.getElementById('stats-content').innerHTML = html;
        }
        
        // Task Tree Functions
        async function loadTaskTree() {
            try {
                const response = await apiCall('/hierarchy/tree');
                displayTaskTree(response.data);
            } catch (error) {
                document.getElementById('task-tree').innerHTML = '<p class="alert alert-error">Failed to load task tree</p>';
            }
        }
        
        function displayTaskTree(tasks) {
            const container = document.getElementById('task-tree');
            if (tasks.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No tasks found. Create your first task!</p>';
                return;
            }
            
            container.innerHTML = tasks.map(task => renderTaskNode(task)).join('');
        }
        
        function renderTaskNode(task) {
            const hasChildren = task.children && task.children.length > 0;
            const childrenHtml = hasChildren ? task.children.map(child => renderTaskNode(child)).join('') : '';
            const expandButtonHtml = hasChildren ? `
                <div class="expand-button" onclick="toggleTaskExpansion(event, '${task.task_code}')" 
                     data-expanded="true">−</div>
            ` : '';
            
            return `
                <div class="task-container" data-task-code="${task.task_code}">
                    <div class="task-node level-${task.task_level} priority-${task.priority}" 
                         onclick="selectTask('${task.task_code}')" 
                         data-task-code="${task.task_code}">
                        ${expandButtonHtml}
                        <div class="task-header">
                            <span class="task-title">${task.title}</span>
                            <span class="task-code">${task.task_code}</span>
                        </div>
                        <div class="task-meta">
                            <span class="status-badge status-${task.status}">${task.status}</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${task.progress_percentage}%"></div>
                            </div>
                            <span>${task.progress_percentage}%</span>
                            ${task.due_date ? `<span>📅 ${task.due_date}</span>` : ''}
                            ${task.owner ? `<span>👤 ${task.owner}</span>` : ''}
                        </div>
                    </div>
                    ${hasChildren ? `<div class="task-children expanded" data-parent="${task.task_code}">${childrenHtml}</div>` : ''}
                </div>
            `;
        }
        
        // Task tree expansion
        function toggleTaskExpansion(event, taskCode) {
            event.stopPropagation(); // Prevent task selection
            
            const container = document.querySelector(`[data-task-code="${taskCode}"]`);
            const expandButton = container.querySelector('.expand-button');
            const childrenContainer = container.querySelector('.task-children');
            
            if (!childrenContainer) return;
            
            const isExpanded = expandButton.getAttribute('data-expanded') === 'true';
            
            if (isExpanded) {
                // Collapse
                childrenContainer.classList.remove('expanded');
                childrenContainer.classList.add('collapsed');
                expandButton.setAttribute('data-expanded', 'false');
                expandButton.textContent = '+';
            } else {
                // Expand
                childrenContainer.classList.remove('collapsed');
                childrenContainer.classList.add('expanded');
                expandButton.setAttribute('data-expanded', 'true');
                expandButton.textContent = '−';
            }
        }
        
        // Task selection
        async function selectTask(taskCode) {
            selectedTask = taskCode;
            
            // Update visual selection
            document.querySelectorAll('.task-node').forEach(node => {
                node.classList.remove('selected');
            });
            document.querySelector(`.task-node[data-task-code="${taskCode}"]`).classList.add('selected');
            
            // Load task details
            await loadTaskDetails(taskCode);
            await loadTaskResources(taskCode);
        }
        
        async function loadTaskDetails(taskCode) {
            try {
                const response = await apiCall(`/hierarchy/tasks/code/${taskCode}?include_context=true`);
                displayTaskDetails(response.data);
            } catch (error) {
                document.getElementById('task-details').innerHTML = '<p class="alert alert-error">Failed to load task details</p>';
            }
        }
        
        function displayTaskDetails(data) {
            const task = data.task;
            const html = `
                <div style="display: grid; gap: 15px;">
                    <div>
                        <h4>${task.title}</h4>
                        <p><strong>Code:</strong> ${task.task_code}</p>
                        <p><strong>Status:</strong> <span class="status-badge status-${task.status}">${task.status}</span></p>
                        <p><strong>Priority:</strong> ${task.priority}</p>
                        <p><strong>Progress:</strong> ${task.progress_percentage}%</p>
                        ${task.description ? `<p><strong>Description:</strong> ${task.description}</p>` : ''}
                        ${task.owner ? `<p><strong>Owner:</strong> ${task.owner}</p>` : ''}
                        ${task.due_date ? `<p><strong>Due Date:</strong> ${task.due_date}</p>` : ''}
                    </div>
                    
                    ${data.ancestors && data.ancestors.length > 0 ? `
                        <div>
                            <strong>Parent Tasks:</strong>
                            ${data.ancestors.map(ancestor => `
                                <span style="display: inline-block; background: var(--bg-tertiary); padding: 2px 6px; border-radius: 3px; margin: 2px;">
                                    ${ancestor.task_code}
                                </span>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${data.descendants && data.descendants.length > 0 ? `
                        <div>
                            <strong>Subtasks:</strong> ${data.descendants.length}
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="editTask('${task.task_code}')" class="btn-small">✏️ Edit</button>
                        <button onclick="addSubtask('${task.task_code}')" class="btn-small btn-secondary">➕ Add Subtask</button>
                        <button onclick="manageTaskResources('${task.task_code}')" class="btn-small btn-secondary">📚 Manage Resources</button>
                    </div>
                </div>
            `;
            document.getElementById('task-details').innerHTML = html;
        }
        
        async function loadTaskResources(taskCode) {
            try {
                const response = await apiCall(`/resources/tasks/${selectedTask}?include_inherited=true`);
                displayTaskResources(response.data);
            } catch (error) {
                document.getElementById('task-resources').innerHTML = '<p class="alert alert-error">Failed to load resources</p>';
            }
        }
        
        function displayTaskResources(resources) {
            if (resources.length === 0) {
                document.getElementById('task-resources').innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No resources assigned to this task</p>';
                return;
            }
            
            const html = resources.map(resource => `
                <div class="resource-item ${resource.assignment_status}">
                    <div class="resource-header flex flex-between flex-center">
                        <span class="resource-source">${resource.source}</span>
                        <span style="font-size: 12px; color: var(--text-muted);">
                            ${resource.inherited ? '🔗 Inherited' : '📎 Direct'}
                        </span>
                    </div>
                    <p style="margin: 5px 0; font-size: 14px;">
                        ${resource.summary || resource.text.substring(0, 100) + '...'}
                    </p>
                    <p style="font-size: 12px; color: var(--text-muted);">
                        Added: ${new Date(resource.assigned_at).toLocaleDateString()}
                        ${resource.assigned_by ? ` by ${resource.assigned_by}` : ''}
                    </p>
                </div>
            `).join('');
            
            document.getElementById('task-resources').innerHTML = html;
        }
        
        // Resource Management Functions
        async function loadResources() {
            const filter = document.getElementById('resource-filter')?.value || '';
            try {
                const endpoint = filter ? `/resources?assignment_status=${filter}` : '/resources';
                const response = await apiCall(endpoint);
                displayResources(response.data);
            } catch (error) {
                document.getElementById('resource-list').innerHTML = '<p class="alert alert-error">Failed to load resources</p>';
            }
        }
        
        function displayResources(resources) {
            if (resources.length === 0) {
                document.getElementById('resource-list').innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No resources found</p>';
                return;
            }
            
            const html = resources.map(resource => `
                <div class="resource-item ${resource.assignment_status}" 
                     onclick="toggleResourceSelection(${resource.id})"
                     ondblclick="showResourceDetail(${resource.id})"
                     data-resource-id="${resource.id}"
                     title="Double-click to view details">
                    <div class="resource-header flex flex-between flex-center">
                        <span class="resource-source">${resource.source}</span>
                        <span class="resource-tasks">${resource.task_count || 0} tasks</span>
                    </div>
                    <p style="margin: 5px 0; font-size: 14px;">
                        ${resource.summary || resource.text.substring(0, 100) + '...'}
                    </p>
                    <p style="font-size: 12px; color: var(--text-muted);">
                        Status: ${resource.assignment_status} | 
                        Created: ${new Date(resource.created_at).toLocaleDateString()}
                    </p>
                </div>
            `).join('');
            
            document.getElementById('resource-list').innerHTML = html;
        }
        
        function toggleResourceSelection(resourceId) {
            console.log(`Toggling selection for resource ID: ${resourceId} (type: ${typeof resourceId})`);
            const element = document.querySelector(`[data-resource-id="${resourceId}"]`);
            
            if (selectedResources.has(resourceId)) {
                selectedResources.delete(resourceId);
                element.classList.remove('selected');
                console.log(`Deselected resource ${resourceId}. Selected count: ${selectedResources.size}`);
            } else {
                selectedResources.add(resourceId);
                element.classList.add('selected');
                console.log(`Selected resource ${resourceId}. Selected count: ${selectedResources.size}`);
            }
            
            updateResourceActions();
        }
        
        function updateResourceActions() {
            const count = selectedResources.size;
            const buttons = document.querySelectorAll('#resource-actions button, .main-content button[onclick*="bulk"]');
            
            buttons.forEach(btn => {
                btn.disabled = count === 0;
            });
            
            if (count === 1) {
                // Show detailed resource information for single selection
                const resourceId = [...selectedResources][0];
                showResourceDetailInPanel(resourceId);
            } else if (count > 1) {
                // Show bulk actions for multiple selections
                document.getElementById('resource-actions').innerHTML = `
                    <h4>Selected Resources: ${count}</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="assignSelectedToTask()" class="btn-small">🔗 Assign to Task</button>
                        <button onclick="viewSelectedDetails()" class="btn-small btn-secondary">👁️ View Details</button>
                        <button onclick="clearSelection()" class="btn-small btn-secondary">❌ Clear Selection</button>
                    </div>
                `;
            } else {
                // No selection - show helper text
                document.getElementById('resource-actions').innerHTML = `
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                        Select a resource to see details and available actions
                    </p>
                `;
            }
        }
        
        async function showResourceDetailInPanel(resourceId) {
            // Show loading state
            document.getElementById('resource-actions').innerHTML = `
                <h3>📚 Resource Details</h3>
                <div class="loading"></div> Loading resource information...
            `;
            
            try {
                console.log(`Loading details for resource ID: ${resourceId}`);
                
                // Since there's no individual resource endpoint, find the resource from the list
                let resource = null;
                
                // First, try to find the resource in the currently loaded resources
                const resourceElement = document.querySelector(`[data-resource-id="${resourceId}"]`);
                if (resourceElement) {
                    // Extract basic info from the DOM element
                    const sourceElement = resourceElement.querySelector('.resource-source');
                    const statusElement = resourceElement.querySelector('.resource-item');
                    const summaryElement = resourceElement.querySelector('p');
                    
                    resource = {
                        id: resourceId,
                        source: sourceElement ? sourceElement.textContent : 'Unknown',
                        assignment_status: statusElement ? statusElement.className.match(/resource-item\s+(\w+)/)?.[1] || 'unknown' : 'unknown',
                        summary: summaryElement ? summaryElement.textContent : '',
                        text: summaryElement ? summaryElement.textContent : '',
                        source_type: 'unknown', // We'll need to get this from the full list
                        created_at: new Date().toISOString() // Placeholder
                    };
                }
                
                // If we couldn't get resource from DOM, fetch from API
                if (!resource) {
                    console.log('Resource not found in DOM, fetching from API...');
                    const allResourcesResponse = await apiCall('/resources');
                    const allResources = allResourcesResponse.data || [];
                    resource = allResources.find(r => r.id == resourceId);
                    
                    if (!resource) {
                        throw new Error(`Resource with ID ${resourceId} not found`);
                    }
                }
                
                console.log('Resource found:', resource);
                
                // Get assigned tasks
                let assignedTasks = [];
                try {
                    const tasksResponse = await apiCall(`/resources/${resourceId}/tasks`);
                    assignedTasks = tasksResponse.data || [];
                    console.log('Assigned tasks:', assignedTasks);
                } catch (taskError) {
                    console.warn('Could not load assigned tasks:', taskError);
                    assignedTasks = [];
                }
                
                // Display detailed information in clean layout
                const html = `
                    <!-- Row 1: Resource Name/Title -->
                    <div style="margin-bottom: 20px; text-align: center; padding-bottom: 15px; border-bottom: 2px solid var(--accent-color);">
                        <h3 style="margin: 0; color: var(--text-primary); font-size: 18px;">📚 ${resource.source || 'Resource #' + resource.id}</h3>
                        <span class="status-badge status-${resource.assignment_status}" style="margin-top: 8px; display: inline-block;">${resource.assignment_status}</span>
                    </div>
                    
                    <!-- Row 2: Action Buttons -->
                    <div style="margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="showAssignResourceModal(${resourceId})" class="btn-small" style="padding: 8px 12px;">
                            🔗 Assign to Task
                        </button>
                        <button onclick="showResourceRawContent(${resourceId})" class="btn-small btn-secondary" style="padding: 8px 12px;">
                            📄 Show Raw
                        </button>
                        ${assignedTasks.length > 0 ? `
                            <button onclick="showUnassignModal(${resourceId})" class="btn-small btn-danger" style="padding: 8px 12px;">
                                ❌ Remove Tasks
                            </button>
                        ` : ''}
                        <button onclick="clearSelection()" class="btn-small btn-secondary" style="padding: 8px 12px;">
                            ← Back
                        </button>
                    </div>
                    
                    <!-- Row 3: Assigned Tasks -->
                    <div style="margin-bottom: 20px;">
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; border-left: 4px solid var(--accent-color);">
                            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: var(--text-primary);">🔗 Assigned Tasks (${assignedTasks.length})</h4>
                            ${assignedTasks.length > 0 ? assignedTasks.map(task => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 6px; background: var(--bg-secondary); border-radius: 5px; cursor: pointer;" 
                                     onclick="switchTab('tasks'); setTimeout(() => selectTask('${task.task_code}'), 100)" 
                                     title="Click to view task details">
                                    <div>
                                        <strong style="font-size: 13px; color: var(--accent-color);">${task.task_code}</strong>
                                        <div style="font-size: 12px; color: var(--text-muted);">${task.title.substring(0, 40)}${task.title.length > 40 ? '...' : ''}</div>
                                    </div>
                                    <button onclick="event.stopPropagation(); unassignFromTask(${resourceId}, ${task.task_id})" 
                                            style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 4px 8px; font-size: 10px; cursor: pointer;"
                                            title="Remove from task">×</button>
                                </div>
                            `).join('') : '<div style="text-align: center; color: var(--text-muted); font-style: italic; padding: 10px;">Not assigned to any tasks</div>'}
                        </div>
                    </div>
                    
                    <!-- Row 4: Resource Type -->
                    <div style="margin-bottom: 20px;">
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; border-left: 4px solid #28a745;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px; color: var(--text-primary);">📝 Resource Type</h4>
                            <span style="background: var(--bg-secondary); padding: 6px 12px; border-radius: 5px; font-size: 13px; color: var(--text-primary);">
                                ${resource.source_type || resource.type || 'Unknown'}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Row 5: Summary -->
                    <div style="margin-bottom: 20px;">
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: var(--text-primary);">📄 Summary</h4>
                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 5px; line-height: 1.6; max-height: 100px; overflow-y: auto; font-size: 13px;">
                                ${resource.summary || (resource.text && resource.text.length > 200 ? resource.text.substring(0, 200) + '...' : resource.text) || 'No summary available'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Row 6: Raw Content Preview -->
                    <div style="margin-bottom: 20px;">
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; border-left: 4px solid #6f42c1;">
                            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: var(--text-primary);">📋 Raw Content</h4>
                            <div style="background: var(--bg-secondary); padding: 10px; border-radius: 5px; font-family: monospace; font-size: 11px; line-height: 1.4; max-height: 80px; overflow-y: auto; color: var(--text-muted);">
                                ${resource.text ? resource.text.substring(0, 150) + (resource.text.length > 150 ? '...' : '') : 'No content available'}
                            </div>
                            <button onclick="showResourceRawContent(${resourceId})" class="btn-small btn-secondary" style="margin-top: 8px; font-size: 11px; padding: 4px 8px;">
                                View Full Content
                            </button>
                        </div>
                    </div>
                    
                    <!-- Footer: Metadata -->
                    <div style="padding-top: 15px; border-top: 1px solid var(--border-light); font-size: 11px; color: var(--text-muted); text-align: center;">
                        Resource ID: ${resource.id} | Created: ${new Date(resource.created_at).toLocaleDateString()}
                    </div>
                `;
                
                document.getElementById('resource-actions').innerHTML = html;
                
            } catch (error) {
                console.error('Resource detail error:', error);
                document.getElementById('resource-actions').innerHTML = `
                    <h3>📚 Resource Details</h3>
                    <div class="alert alert-error">
                        <strong>Failed to load resource details</strong><br>
                        <small>Error: ${error.message || 'Unknown error'}</small><br>
                        <small>Resource ID: ${resourceId}</small>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="showResourceDetailInPanel(${resourceId})" class="btn-small">🔄 Retry</button>
                        <button onclick="clearSelection()" class="btn-small btn-secondary">← Back to Actions</button>
                        <button onclick="showResourceDetail(${resourceId})" class="btn-small btn-secondary">📄 Open in Modal</button>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 5px; font-size: 12px;">
                        <strong>Debug Info:</strong><br>
                        <small>Check browser console for detailed error information</small>
                    </div>
                `;
            }
        }
        
        function clearSelection() {
            selectedResources.clear();
            document.querySelectorAll('.resource-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            updateResourceActions();
        }
        
        // Q&A Functions
        function setupEventListeners() {
            // Context scope selection
            document.querySelectorAll('.context-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.context-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    currentScope = this.getAttribute('data-scope');
                });
            });
            
            // QA Form
            document.getElementById('qa-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await askQuestion();
            });
            
            // Ingest Form
            document.getElementById('ingest-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await ingestDocument();
            });
        }
        
        async function askQuestion() {
            const question = document.getElementById('question').value;
            
            if (!question.trim()) return;
            
            const answerDiv = document.getElementById('qa-answer');
            answerDiv.innerHTML = '<div class="loading"></div> Thinking...';
            
            try {
                let response;
                
                if (currentContextMode === 'single') {
                    const taskCode = document.getElementById('task-code').value;
                    if (taskCode) {
                        // Single task Q&A
                        response = await apiCall(`/ask/task/${taskCode}`, {
                            method: 'POST',
                            body: JSON.stringify({
                                question: question,
                                scope: currentScope,
                                top_k: 6
                            })
                        });
                    } else {
                        // General Q&A
                        response = await apiCall('/ask/enhanced', {
                            method: 'POST',
                            body: JSON.stringify({
                                question: question,
                                scope: currentScope,
                                top_k: 6
                            })
                        });
                    }
                } else if (currentContextMode === 'multi') {
                    // Multi-task Q&A - combine context from multiple tasks
                    if (selectedTasksForContext.size === 0) {
                        showAlert('Please select at least one task for multi-task context', 'warning');
                        answerDiv.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">Please select tasks for context</p>';
                        return;
                    }
                    
                    response = await handleMultiTaskQuestion(question);
                } else {
                    // General Q&A mode
                    response = await apiCall('/ask/enhanced', {
                        method: 'POST',
                        body: JSON.stringify({
                            question: question,
                            top_k: 6
                        })
                    });
                }
                
                displayAnswer(response.data);
            } catch (error) {
                answerDiv.innerHTML = '<p class="alert alert-error">Failed to get answer</p>';
            }
        }
        
        async function handleMultiTaskQuestion(question) {
            // For multi-task questions, we'll use enhanced ask with combined context
            // This is a simplified implementation - in a real system you might want to
            // aggregate resources from multiple tasks differently
            
            const taskCodes = Array.from(selectedTasksForContext);
            
            // Use the first task as primary context, but indicate multi-task mode
            const primaryTaskCode = taskCodes[0];
            
            const response = await apiCall(`/ask/task/${primaryTaskCode}`, {
                method: 'POST',
                body: JSON.stringify({
                    question: question,
                    scope: currentScope,
                    top_k: 6
                })
            });
            
            // Add multi-task context info to the response
            if (response.data) {
                response.data.multi_task_context = {
                    task_codes: taskCodes,
                    primary_task: primaryTaskCode,
                    total_tasks: taskCodes.length
                };
            }
            
            return response;
        }
        
        function displayAnswer(data) {
            const html = `
                <div class="answer-section">
                    <h4>Answer:</h4>
                    <p style="line-height: 1.6; margin-bottom: 15px;">${data.answer}</p>
                    
                    ${data.multi_task_context ? `
                        <div style="background: var(--success-bg); padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid var(--accent-color);">
                            <strong>🔗 Multi-Task Context:</strong> Combined resources from ${data.multi_task_context.total_tasks} tasks
                            <br><small>Tasks: ${data.multi_task_context.task_codes.join(', ')} | Primary: ${data.multi_task_context.primary_task}</small>
                        </div>
                    ` : ''}
                    
                    ${data.task_context && !data.multi_task_context ? `
                        <div style="background: var(--bg-secondary); padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                            <strong>Task Context:</strong> ${data.task_context.task_title} (${data.task_context.task_code})
                            | Scope: ${data.task_context.scope}
                        </div>
                    ` : ''}
                    
                    ${data.context_summary ? `
                        <div style="font-size: 12px; color: var(--text-muted);">
                            <strong>Context Used:</strong> 
                            ${data.context_summary.documents_used} documents 
                            (Task: ${data.context_summary.task_specific}, 
                            Inherited: ${data.context_summary.inherited}, 
                            General: ${data.context_summary.general})
                        </div>
                    ` : ''}
                    
                    ${data.suggested_next_steps && data.suggested_next_steps.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <strong>Suggested Next Steps:</strong>
                            <ul style="margin: 5px 0 0 20px;">
                                ${data.suggested_next_steps.map(step => `<li>${step}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${currentContextMode === 'multi' && selectedTasksForContext.size > 0 ? `
                        <div style="margin-top: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 5px;">
                            <strong>📊 Context Preview:</strong>
                            <button onclick="showMultiTaskContextPreview()" class="btn-small" style="margin-left: 10px;">View Combined Resources</button>
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('qa-answer').innerHTML = html;
        }
        
        async function showMultiTaskContextPreview() {
            if (selectedTasksForContext.size === 0) {
                showAlert('No tasks selected', 'warning');
                return;
            }
            
            try {
                const taskCodes = Array.from(selectedTasksForContext);
                let totalResources = 0;
                let taskSummaries = [];
                
                // Get resource counts for each task
                for (const taskCode of taskCodes) {
                    try {
                        const response = await apiCall(`/ask/task/${taskCode}/context?scope=${currentScope}`);
                        const contextData = response.data;
                        
                        taskSummaries.push({
                            task_code: taskCode,
                            task_title: contextData.task.title,
                            resource_count: contextData.available_resources.total,
                            breakdown: contextData.available_resources
                        });
                        
                        totalResources += contextData.available_resources.total;
                    } catch (error) {
                        console.error(`Failed to get context for ${taskCode}:`, error);
                    }
                }
                
                const summaryHtml = taskSummaries.map(summary => `
                    <div style="padding: 10px; border: 1px solid var(--border-light); border-radius: 5px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: between; align-items: center;">
                            <strong>${summary.task_code}</strong>
                            <span class="resource-source">${summary.resource_count} resources</span>
                        </div>
                        <p style="margin: 5px 0; font-size: 14px;">${summary.task_title}</p>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            Task-specific: ${summary.breakdown.task_specific} | 
                            Inherited: ${summary.breakdown.inherited} | 
                            General: ${summary.breakdown.general}
                        </div>
                    </div>
                `).join('');
                
                showModal(`
                    <div style="max-width: 600px; max-height: 80vh;">
                        <h3>📊 Multi-Task Context Preview</h3>
                        <div style="margin-bottom: 20px;">
                            <p><strong>Total Resources:</strong> ${totalResources} from ${taskCodes.length} tasks</p>
                            <p><strong>Context Scope:</strong> ${currentScope}</p>
                        </div>
                        
                        <h4>Task Breakdown:</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${summaryHtml}
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button onclick="closeModal()" class="btn-secondary">Close</button>
                        </div>
                    </div>
                `);
                
            } catch (error) {
                showAlert('Failed to load context preview', 'error');
            }
        }
        
        async function previewContext() {
            const taskCode = document.getElementById('task-code').value;
            if (!taskCode) {
                showAlert('Please enter a task code first', 'warning');
                return;
            }
            
            try {
                const response = await apiCall(`/ask/task/${taskCode}/context?scope=${currentScope}`);
                displayContextPreview(response.data);
            } catch (error) {
                showAlert('Failed to load context preview', 'error');
            }
        }
        
        function displayContextPreview(data) {
            showModal(`
                <h3>Context Preview: ${data.task.task_code}</h3>
                <p><strong>Task:</strong> ${data.task.title}</p>
                <p><strong>Scope:</strong> ${data.scope}</p>
                <p><strong>Available Resources:</strong> ${data.available_resources.total}</p>
                <ul>
                    <li>Task-specific: ${data.available_resources.task_specific}</li>
                    <li>Inherited: ${data.available_resources.inherited}</li>
                    <li>General: ${data.available_resources.general}</li>
                </ul>
                
                ${data.suggested_scopes.length > 1 ? `
                    <div style="margin-top: 15px;">
                        <strong>Available Scopes:</strong>
                        ${data.suggested_scopes.map(scope => `
                            <div style="margin: 5px 0; padding: 8px; background: var(--bg-tertiary); border-radius: 3px;">
                                <strong>${scope.name}:</strong> ${scope.description}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <button onclick="closeModal()" style="margin-top: 15px;">Close</button>
            `);
        }
        
        // Ingest Document
        async function ingestDocument() {
            const text = document.getElementById('document-text').value;
            const sourceType = document.getElementById('source-type').value;
            const source = document.getElementById('source').value;
            
            if (!text.trim()) return;
            
            const button = document.querySelector('#ingest-form button[type="submit"]');
            setButtonLoading(button, true, 'Add Document & Extract Tasks');
            
            try {
                const response = await apiCall('/ingest', {
                    method: 'POST',
                    body: JSON.stringify({
                        text: text,
                        source: source || sourceType,
                        source_type: sourceType
                    })
                });
                
                showAlert('Document processed successfully!', 'success');
                document.getElementById('ingest-form').reset();
                
                // Refresh data
                loadStats();
                loadTaskTree();
                loadResources();
                
            } catch (error) {
                showAlert('Failed to process document', 'error');
            } finally {
                setButtonLoading(button, false, 'Add Document & Extract Tasks');
            }
        }
        
        // Utility Functions
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '1001';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.maxWidth = '400px';
            alertDiv.style.wordWrap = 'break-word';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        function setLoadingState(elementId, isLoading, loadingText = 'Loading...') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (isLoading) {
                element.innerHTML = `<div class="loading"></div> ${loadingText}`;
                element.classList.add('fade-in');
            } else {
                element.classList.remove('fade-in');
            }
        }
        
        function setButtonLoading(button, isLoading, originalText = '') {
            if (!button) return;
            
            if (isLoading) {
                button.dataset.originalText = button.textContent;
                button.classList.add('btn-loading');
                button.disabled = true;
            } else {
                button.classList.remove('btn-loading');
                button.disabled = false;
                if (button.dataset.originalText) {
                    button.textContent = button.dataset.originalText;
                    delete button.dataset.originalText;
                } else if (originalText) {
                    button.textContent = originalText;
                }
            }
        }
        
        function setElementContent(elementId, content, fallbackMessage = 'No data available') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (content) {
                element.innerHTML = content;
            } else {
                element.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 20px;">${fallbackMessage}</p>`;
            }
        }
        
        function showModal(content) {
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }
        
        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }
        
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // ESC to close modal
                if (e.key === 'Escape') {
                    const modal = document.getElementById('modal-overlay');
                    if (!modal.classList.contains('hidden')) {
                        closeModal();
                        return;
                    }
                }
                
                // Don't trigger shortcuts when typing in inputs
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    return;
                }
                
                // Ctrl/Cmd shortcuts
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'n':
                            e.preventDefault();
                            showCreateTaskModal();
                            break;
                        case 'k':
                            e.preventDefault();
                            document.getElementById('question').focus();
                            break;
                        case 'r':
                            e.preventDefault();
                            location.reload();
                            break;
                    }
                }
                
                // Alt shortcuts for tab switching
                if (e.altKey) {
                    switch(e.key) {
                        case '1':
                            e.preventDefault();
                            switchTab('overview');
                            break;
                        case '2':
                            e.preventDefault();
                            switchTab('tasks');
                            break;
                        case '3':
                            e.preventDefault();
                            switchTab('resources');
                            break;
                        case '4':
                            e.preventDefault();
                            switchTab('qa');
                            break;
                        case '5':
                            e.preventDefault();
                            switchTab('ingest');
                            break;
                    }
                }
                
                // Other shortcuts
                switch(e.key) {
                    case 'F1':
                        e.preventDefault();
                        showKeyboardShortcuts();
                        break;
                    case 't':
                        if (!e.ctrlKey && !e.metaKey && !e.altKey) {
                            toggleTheme();
                        }
                        break;
                }
            });
        }
        
        function showKeyboardShortcuts() {
            showModal(`
                <h3>⌨️ Keyboard Shortcuts</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div>
                        <h4>General</h4>
                        <ul style="margin: 10px 0; line-height: 1.6;">
                            <li><kbd>Esc</kbd> - Close modal</li>
                            <li><kbd>T</kbd> - Toggle theme</li>
                            <li><kbd>Ctrl+R</kbd> - Refresh page</li>
                            <li><kbd>F1</kbd> - Show shortcuts</li>
                        </ul>
                        
                        <h4>Navigation</h4>
                        <ul style="margin: 10px 0; line-height: 1.6;">
                            <li><kbd>Alt+1</kbd> - Overview tab</li>
                            <li><kbd>Alt+2</kbd> - Tasks tab</li>
                            <li><kbd>Alt+3</kbd> - Resources tab</li>
                            <li><kbd>Alt+4</kbd> - Q&A tab</li>
                            <li><kbd>Alt+5</kbd> - Ingest tab</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4>Actions</h4>
                        <ul style="margin: 10px 0; line-height: 1.6;">
                            <li><kbd>Ctrl+N</kbd> - New task</li>
                            <li><kbd>Ctrl+K</kbd> - Focus question input</li>
                        </ul>
                        
                        <h4>Tips</h4>
                        <ul style="margin: 10px 0; line-height: 1.6; font-size: 14px;">
                            <li>Double-click resources to view details</li>
                            <li>Click expand buttons (±) on tasks</li>
                            <li>Use multi-task mode for complex queries</li>
                        </ul>
                    </div>
                </div>
                
                <style>
                    kbd {
                        background: var(--kbd-bg);
                        border: 1px solid var(--kbd-border);
                        border-radius: 3px;
                        padding: 2px 4px;
                        font-family: monospace;
                        font-size: 11px;
                    }
                </style>
                
                <button onclick="closeModal()" style="margin-top: 20px;">Close</button>
            `);
        }
        
        // Task Management Functions
        function showCreateTaskModal(parentTaskCode = null) {
            const parentInfo = parentTaskCode ? `
                <div class="form-group">
                    <label>Parent Task</label>
                    <input type="text" id="parent-task-code" value="${parentTaskCode}" readonly>
                    <small>This task will be created as a subtask of ${parentTaskCode}</small>
                </div>
            ` : `
                <div class="form-group">
                    <label>Parent Task (optional)</label>
                    <input type="text" id="parent-task-code" placeholder="Leave empty for root task">
                    <small>Enter task code to create as subtask</small>
                </div>
            `;
            
            showModal(`
                <h3>${parentTaskCode ? 'Create Subtask' : 'Create New Task'}</h3>
                <form id="create-task-form">
                    <div class="form-group">
                        <label>Task Title *</label>
                        <input type="text" id="task-title" placeholder="Enter task title" required>
                    </div>
                    
                    ${parentInfo}
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="task-description" placeholder="Task description (optional)" rows="3"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Priority</label>
                            <select id="task-priority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="task-due-date">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Owner</label>
                        <input type="text" id="task-owner" placeholder="Task owner (optional)">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit">Create Task</button>
                        <button type="button" onclick="closeModal()" class="btn-secondary">Cancel</button>
                    </div>
                </form>
            `);
            
            // Handle form submission
            document.getElementById('create-task-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await createTask();
            });
        }
        
        async function createTask() {
            const title = document.getElementById('task-title').value.trim();
            const parentTaskCode = document.getElementById('parent-task-code').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const priority = document.getElementById('task-priority').value;
            const dueDate = document.getElementById('task-due-date').value;
            const owner = document.getElementById('task-owner').value.trim();
            
            if (!title) {
                showAlert('Task title is required', 'error');
                return;
            }
            
            const submitButton = document.querySelector('#create-task-form button[type="submit"]');
            setButtonLoading(submitButton, true, 'Create Task');
            
            try {
                // First, get parent task ID if parent code is provided
                let parentTaskId = null;
                if (parentTaskCode) {
                    try {
                        const parentResponse = await apiCall(`/hierarchy/tasks/code/${parentTaskCode}`);
                        parentTaskId = parentResponse.data.task.id;
                    } catch (error) {
                        showAlert(`Parent task "${parentTaskCode}" not found`, 'error');
                        return;
                    }
                }
                
                // Create the task
                const taskData = {
                    title: title,
                    parent_task_id: parentTaskId,
                    description: description || null,
                    priority: priority,
                    due_date: dueDate || null,
                    owner: owner || null
                };
                
                const response = await apiCall('/hierarchy/tasks', {
                    method: 'POST',
                    body: JSON.stringify(taskData)
                });
                
                showAlert(`Task "${response.data.task_code}" created successfully!`, 'success');
                closeModal();
                
                // Refresh task tree and select the new task
                await loadTaskTree();
                if (response.data.task_code) {
                    setTimeout(() => selectTask(response.data.task_code), 500);
                }
                
            } catch (error) {
                showAlert('Failed to create task', 'error');
                console.error('Create task error:', error);
            } finally {
                setButtonLoading(submitButton, false, 'Create Task');
            }
        }
        
        function editTask(taskCode) {
            showAlert(`Edit task ${taskCode} - Coming soon!`, 'info');
        }
        
        function addSubtask(taskCode) {
            showCreateTaskModal(taskCode);
        }
        
        function manageTaskResources(taskCode) {
            showAlert(`Manage resources for ${taskCode} - Coming soon!`, 'info');
        }
        
        async function assignSelectedToTask() {
            if (selectedResources.size === 0) {
                showAlert('No resources selected', 'warning');
                return;
            }
            
            try {
                // Get list of available tasks
                const tasksResponse = await apiCall('/hierarchy/tree');
                const allTasks = flattenTaskTree(tasksResponse.data);
                
                showModal(`
                    <h3>🔗 Assign ${selectedResources.size} Resources to Task</h3>
                    <form id="bulk-assign-form">
                        <div class="form-group">
                            <label>Select Task</label>
                            <select id="bulk-assign-task-select" required>
                                <option value="">Choose a task...</option>
                                ${allTasks.map(task => `
                                    <option value="${task.id}">
                                        ${'  '.repeat(task.task_level)}${task.task_code} - ${task.title}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Assigned By (optional)</label>
                            <input type="text" id="bulk-assigned-by" placeholder="Your name">
                        </div>
                        
                        <div style="background: var(--bg-tertiary); padding: 10px; border-radius: 5px; margin: 15px 0;">
                            <h4>Selected Resources: ${selectedResources.size}</h4>
                            <p style="font-size: 12px; color: var(--text-muted);">All selected resources will be assigned to the chosen task.</p>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit">Assign All Resources</button>
                            <button type="button" onclick="closeModal()" class="btn-secondary">Cancel</button>
                        </div>
                    </form>
                `);
                
                document.getElementById('bulk-assign-form').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await bulkAssignToTask();
                });
                
            } catch (error) {
                showAlert('Failed to load tasks for assignment', 'error');
            }
        }
        
        async function bulkAssignToTask() {
            const taskId = document.getElementById('bulk-assign-task-select').value;
            const assignedBy = document.getElementById('bulk-assigned-by').value.trim();
            
            if (!taskId) {
                showAlert('Please select a task', 'error');
                return;
            }
            
            const submitButton = document.querySelector('#bulk-assign-form button[type="submit"]');
            setButtonLoading(submitButton, true, 'Assign All Resources');
            
            try {
                const resourceIds = Array.from(selectedResources);
                
                // Use bulk assign API
                await apiCall(`/resources/tasks/${taskId}/assign`, {
                    method: 'POST',
                    body: JSON.stringify({
                        resource_ids: resourceIds,
                        assigned_by: assignedBy || null
                    })
                });
                
                showAlert(`${resourceIds.length} resources assigned successfully!`, 'success');
                closeModal();
                
                // Clear selection and refresh
                clearSelection();
                loadResources();
                if (selectedTask) {
                    loadTaskResources(selectedTask);
                }
                
            } catch (error) {
                showAlert('Failed to assign resources', 'error');
            } finally {
                setButtonLoading(submitButton, false, 'Assign All Resources');
            }
        }
        
        function bulkAssignResources() {
            assignSelectedToTask();
        }
        
        async function bulkArchiveResources() {
            if (selectedResources.size === 0) {
                showAlert('No resources selected', 'warning');
                return;
            }
            
            if (!confirm(`Are you sure you want to archive ${selectedResources.size} resources?`)) {
                return;
            }
            
            try {
                const resourceIds = Array.from(selectedResources);
                
                await apiCall('/resources/bulk/archive', {
                    method: 'PUT',
                    body: JSON.stringify(resourceIds)
                });
                
                showAlert(`${resourceIds.length} resources archived successfully!`, 'success');
                
                // Clear selection and refresh
                clearSelection();
                loadResources();
                
            } catch (error) {
                showAlert('Failed to archive resources', 'error');
            }
        }
        
        async function bulkUnarchiveResources() {
            if (selectedResources.size === 0) {
                showAlert('No resources selected', 'warning');
                return;
            }
            
            try {
                const resourceIds = Array.from(selectedResources);
                
                await apiCall('/resources/bulk/unarchive', {
                    method: 'PUT',
                    body: JSON.stringify(resourceIds)
                });
                
                showAlert(`${resourceIds.length} resources unarchived successfully!`, 'success');
                
                // Clear selection and refresh
                clearSelection();
                loadResources();
                
            } catch (error) {
                showAlert('Failed to unarchive resources', 'error');
            }
        }
        
        function exportSelectedResources() {
            if (selectedResources.size === 0) {
                showAlert('No resources selected', 'warning');
                return;
            }
            
            showAlert('Export functionality - Coming soon!', 'info');
        }
        
        // Context Selection Functions
        function switchContextMode(mode) {
            currentContextMode = mode;
            
            // Update UI
            document.querySelectorAll('[data-mode]').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // Show/hide panels
            document.querySelectorAll('.context-mode-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            
            if (mode === 'single') {
                document.getElementById('single-task-context').style.display = 'block';
            } else if (mode === 'multi') {
                document.getElementById('multi-task-context').style.display = 'block';
            }
            // General mode doesn't need a specific panel
        }
        
        async function showTaskSelector() {
            try {
                const tasksResponse = await apiCall('/hierarchy/tree');
                const allTasks = flattenTaskTree(tasksResponse.data);
                
                const taskList = allTasks.map(task => {
                    const isSelected = selectedTasksForContext.has(task.task_code);
                    return `
                        <div class="task-selector-item ${isSelected ? 'selected' : ''}" 
                             onclick="toggleTaskForContext('${task.task_code}')"
                             data-task-code="${task.task_code}">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation();">
                                <div>
                                    <strong>${task.task_code}</strong>: ${task.title}
                                    <br><small>Level ${task.task_level} | Status: ${task.status}</small>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                showModal(`
                    <div style="max-width: 600px; max-height: 80vh;">
                        <h3>📋 Select Tasks for Context</h3>
                        <div style="margin-bottom: 15px;">
                            <p>Select multiple tasks to combine their resources for Q&A context.</p>
                            <p><strong>Currently selected:</strong> ${selectedTasksForContext.size} tasks</p>
                        </div>
                        
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-light); border-radius: 5px;">
                            ${taskList}
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button onclick="confirmTaskSelection()">Confirm Selection</button>
                            <button onclick="closeModal()" class="btn-secondary">Cancel</button>
                        </div>
                    </div>
                `);
                
                // Add CSS for task selector items if not already added
                if (!document.getElementById('task-selector-styles')) {
                    const style = document.createElement('style');
                    style.id = 'task-selector-styles';
                    style.textContent = `
                        .task-selector-item {
                            padding: 10px;
                            border-bottom: 1px solid var(--border-light);
                            cursor: pointer;
                            transition: all 0.3s ease;
                        }
                        .task-selector-item:hover {
                            background: var(--bg-tertiary);
                        }
                        .task-selector-item.selected {
                            background: var(--success-bg);
                            border-left: 4px solid var(--accent-color);
                        }
                    `;
                    document.head.appendChild(style);
                }
                
            } catch (error) {
                showAlert('Failed to load tasks', 'error');
            }
        }
        
        function toggleTaskForContext(taskCode) {
            const item = document.querySelector(`[data-task-code="${taskCode}"]`);
            const checkbox = item.querySelector('input[type="checkbox"]');
            
            if (selectedTasksForContext.has(taskCode)) {
                selectedTasksForContext.delete(taskCode);
                item.classList.remove('selected');
                checkbox.checked = false;
            } else {
                selectedTasksForContext.add(taskCode);
                item.classList.add('selected');
                checkbox.checked = true;
            }
        }
        
        function confirmTaskSelection() {
            updateSelectedTasksDisplay();
            closeModal();
            showAlert(`${selectedTasksForContext.size} tasks selected for context`, 'success');
        }
        
        function updateSelectedTasksDisplay() {
            const display = document.getElementById('selected-tasks-display');
            
            if (selectedTasksForContext.size === 0) {
                display.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No tasks selected. Click "Add Tasks" to select tasks for context.</p>';
            } else {
                const taskTags = Array.from(selectedTasksForContext).map(taskCode => `
                    <span style="display: inline-block; background: var(--accent-color); color: white; padding: 4px 8px; border-radius: 3px; margin: 2px; font-size: 12px;">
                        ${taskCode}
                        <button onclick="removeTaskFromContext('${taskCode}')" style="background: none; border: none; color: white; margin-left: 5px; cursor: pointer;">×</button>
                    </span>
                `).join('');
                
                display.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>${selectedTasksForContext.size} tasks selected:</strong>
                    </div>
                    <div>${taskTags}</div>
                `;
            }
        }
        
        function removeTaskFromContext(taskCode) {
            selectedTasksForContext.delete(taskCode);
            updateSelectedTasksDisplay();
        }
        
        function clearSelectedTasks() {
            selectedTasksForContext.clear();
            updateSelectedTasksDisplay();
        }
        
        async function viewSelectedDetails() {
            if (selectedResources.size === 0) {
                showAlert('No resources selected', 'warning');
                return;
            }
            
            if (selectedResources.size === 1) {
                // Show detail for single resource
                const resourceId = [...selectedResources][0];
                await showResourceDetail(resourceId);
            } else {
                // Show summary for multiple resources
                showMultiResourceSummary();
            }
        }
        
        async function showResourceDetail(resourceId) {
            try {
                // Get resource details
                const resourceResponse = await apiCall(`/resources/${resourceId}`);
                const resource = resourceResponse.data;
                
                // Get assigned tasks
                const tasksResponse = await apiCall(`/resources/${resourceId}/tasks`);
                const assignedTasks = tasksResponse.data;
                
                const modal = `
                    <div style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <h3>📚 Resource Details</h3>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                                <span class="resource-source">${resource.source}</span>
                                <span class="status-badge status-${resource.assignment_status}">${resource.assignment_status}</span>
                            </div>
                            
                            <h4>Summary</h4>
                            <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                                ${resource.summary || 'No summary available'}
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button onclick="showResourceRawContent(${resourceId})" class="btn-small">📄 View Raw Content</button>
                                <button onclick="showAssignResourceModal(${resourceId})" class="btn-small">🔗 Assign to Task</button>
                                ${assignedTasks.length > 0 ? `<button onclick="showUnassignModal(${resourceId})" class="btn-small btn-danger">❌ Remove from Tasks</button>` : ''}
                            </div>
                            
                            <h4>Assigned Tasks (${assignedTasks.length})</h4>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${assignedTasks.length > 0 ? assignedTasks.map(task => `
                                    <div style="padding: 8px; border: 1px solid var(--border-light); border-radius: 5px; margin-bottom: 5px; display: flex; justify-content: between; align-items: center;">
                                        <div>
                                            <strong>${task.task_code}</strong>: ${task.title}
                                            <br><small>Assigned: ${new Date(task.assigned_at).toLocaleDateString()}</small>
                                        </div>
                                        <button onclick="unassignFromTask(${resourceId}, ${task.task_id})" class="btn-small btn-danger">Remove</button>
                                    </div>
                                `).join('') : '<p style="color: var(--text-muted); text-align: center; padding: 20px;">Not assigned to any tasks</p>'}
                            </div>
                            
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-light); font-size: 12px; color: var(--text-muted);">
                                <p><strong>Created:</strong> ${new Date(resource.created_at).toLocaleString()}</p>
                                <p><strong>Resource ID:</strong> ${resource.id}</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="closeModal()" class="btn-secondary">Close</button>
                        </div>
                    </div>
                `;
                
                showModal(modal);
                
            } catch (error) {
                showAlert('Failed to load resource details', 'error');
                console.error('Resource detail error:', error);
            }
        }
        
        async function showResourceRawContent(resourceId) {
            try {
                const response = await apiCall(`/resources/${resourceId}`);
                const resource = response.data;
                
                showModal(`
                    <div style="max-width: 700px; max-height: 80vh;">
                        <h3>📄 Raw Content - ${resource.source}</h3>
                        <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 5px; max-height: 60vh; overflow-y: auto; white-space: pre-wrap; font-family: monospace; font-size: 12px; line-height: 1.4;">
${resource.text}
                        </div>
                        <div style="margin-top: 15px;">
                            <button onclick="showResourceDetail(${resourceId})" class="btn-secondary">← Back to Details</button>
                            <button onclick="closeModal()">Close</button>
                        </div>
                    </div>
                `);
            } catch (error) {
                showAlert('Failed to load raw content', 'error');
            }
        }
        
        function showMultiResourceSummary() {
            const count = selectedResources.size;
            showModal(`
                <h3>📚 Multiple Resources Selected</h3>
                <p>You have selected <strong>${count}</strong> resources.</p>
                <div style="margin: 20px 0;">
                    <h4>Available Actions:</h4>
                    <div style="display: grid; gap: 10px;">
                        <button onclick="bulkAssignToTask()" class="btn-small">🔗 Assign All to Task</button>
                        <button onclick="bulkArchiveResources()" class="btn-small btn-secondary">📦 Archive All</button>
                        <button onclick="bulkUnarchiveResources()" class="btn-small btn-secondary">📤 Unarchive All</button>
                        <button onclick="exportSelectedResources()" class="btn-small btn-secondary">💾 Export Selection</button>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button onclick="closeModal()" class="btn-secondary">Close</button>
                </div>
            `);
        }
        
        async function showAssignResourceModal(resourceId) {
            try {
                // Get list of available tasks
                const tasksResponse = await apiCall('/hierarchy/tree');
                const allTasks = flattenTaskTree(tasksResponse.data);
                
                showModal(`
                    <h3>🔗 Assign Resource to Task</h3>
                    <form id="assign-resource-form">
                        <div class="form-group">
                            <label>Select Task</label>
                            <select id="assign-task-select" required>
                                <option value="">Choose a task...</option>
                                ${allTasks.map(task => `
                                    <option value="${task.id}">
                                        ${'  '.repeat(task.task_level)}${task.task_code} - ${task.title}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Assigned By (optional)</label>
                            <input type="text" id="assigned-by" placeholder="Your name">
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit">Assign Resource</button>
                            <button type="button" onclick="closeModal()" class="btn-secondary">Cancel</button>
                        </div>
                    </form>
                `);
                
                document.getElementById('assign-resource-form').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await assignResourceToTask(resourceId);
                });
                
            } catch (error) {
                showAlert('Failed to load tasks for assignment', 'error');
            }
        }
        
        function flattenTaskTree(tasks) {
            let flattened = [];
            for (const task of tasks) {
                flattened.push(task);
                if (task.children && task.children.length > 0) {
                    flattened = flattened.concat(flattenTaskTree(task.children));
                }
            }
            return flattened;
        }
        
        async function assignResourceToTask(resourceId) {
            const taskId = document.getElementById('assign-task-select').value;
            const assignedBy = document.getElementById('assigned-by').value.trim();
            
            if (!taskId) {
                showAlert('Please select a task', 'error');
                return;
            }
            
            try {
                await apiCall(`/resources/${resourceId}/assign`, {
                    method: 'POST',
                    body: JSON.stringify({
                        task_ids: [parseInt(taskId)],
                        assigned_by: assignedBy || null
                    })
                });
                
                showAlert('Resource assigned successfully!', 'success');
                closeModal();
                
                // Refresh displays
                loadResources();
                if (selectedTask) {
                    loadTaskResources(selectedTask);
                }
                
            } catch (error) {
                showAlert('Failed to assign resource', 'error');
            }
        }
        
        async function unassignFromTask(resourceId, taskId) {
            if (!confirm('Are you sure you want to remove this resource from the task?')) {
                return;
            }
            
            try {
                await apiCall(`/resources/${resourceId}/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                
                showAlert('Resource removed from task', 'success');
                
                // Refresh the detail panel if it's showing
                if (selectedResources.has(resourceId) && selectedResources.size === 1) {
                    await showResourceDetailInPanel(resourceId);
                } else {
                    // Refresh the resource detail modal if it was open
                    await showResourceDetail(resourceId);
                }
                
                // Refresh other displays
                loadResources();
                if (selectedTask) {
                    loadTaskResources(selectedTask);
                }
                
            } catch (error) {
                showAlert('Failed to remove resource from task', 'error');
            }
        }
        
        async function showUnassignModal(resourceId) {
            try {
                // Get assigned tasks for this resource
                const tasksResponse = await apiCall(`/resources/${resourceId}/tasks`);
                const assignedTasks = tasksResponse.data;
                
                if (assignedTasks.length === 0) {
                    showAlert('This resource is not assigned to any tasks', 'info');
                    return;
                }
                
                const taskList = assignedTasks.map(task => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid var(--border-light); border-radius: 5px; margin-bottom: 8px;">
                        <div>
                            <strong>${task.task_code}</strong>: ${task.title}
                            <br><small>Assigned: ${new Date(task.assigned_at).toLocaleDateString()}</small>
                        </div>
                        <button onclick="unassignFromTask(${resourceId}, ${task.task_id}); closeModal();" class="btn-small btn-danger">
                            Remove
                        </button>
                    </div>
                `).join('');
                
                showModal(`
                    <h3>❌ Remove Resource from Tasks</h3>
                    <p>Select which tasks to remove this resource from:</p>
                    
                    <div style="max-height: 300px; overflow-y: auto; margin: 15px 0;">
                        ${taskList}
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button onclick="removeFromAllTasks(${resourceId})" class="btn-danger">
                            Remove from All Tasks
                        </button>
                        <button onclick="closeModal()" class="btn-secondary">Cancel</button>
                    </div>
                `);
                
            } catch (error) {
                showAlert('Failed to load task assignments', 'error');
            }
        }
        
        async function removeFromAllTasks(resourceId) {
            if (!confirm('Are you sure you want to remove this resource from ALL assigned tasks?')) {
                return;
            }
            
            try {
                const tasksResponse = await apiCall(`/resources/${resourceId}/tasks`);
                const assignedTasks = tasksResponse.data;
                
                // Remove from each task
                for (const task of assignedTasks) {
                    await apiCall(`/resources/${resourceId}/tasks/${task.task_id}`, {
                        method: 'DELETE'
                    });
                }
                
                showAlert(`Resource removed from ${assignedTasks.length} tasks`, 'success');
                closeModal();
                
                // Refresh displays
                if (selectedResources.has(resourceId) && selectedResources.size === 1) {
                    await showResourceDetailInPanel(resourceId);
                }
                loadResources();
                if (selectedTask) {
                    loadTaskResources(selectedTask);
                }
                
            } catch (error) {
                showAlert('Failed to remove resource from tasks', 'error');
            }
        }
    </script>
</body>
</html>